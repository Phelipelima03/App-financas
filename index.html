<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MetaCartão</title>

<style>
:root{
--bg:#0b0d12;--panel:#121622;--panel2:#1a2032;
--text:#e8eefc;--muted:#aab4d6;
--line:rgba(255,255,255,.08);
--blue:#5bc0ff;--green:#35d07f;--orange:#ffb347;--red:#ff5b5b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui}
.app{max-width:1100px;margin:auto;padding:16px}
.btn{padding:10px 14px;border-radius:12px;border:0;font-weight:800;cursor:pointer}
.btnGhost{background:var(--panel2);color:var(--text)}
.btnGreen{background:var(--green);color:#06120a}
.btnOrange{background:var(--orange);color:#1a0f00}
.btnRed{background:var(--red);color:#1a0404}
.panel{background:var(--panel);border-radius:16px;padding:14px;margin-bottom:14px}
.panel h3{margin:0 0 10px}
.list{display:flex;flex-direction:column;gap:10px}
.item{background:var(--panel2);padding:12px;border-radius:12px}
.muted{color:var(--muted);font-size:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
select,input{padding:10px;border-radius:10px;border:1px solid var(--line);background:#000;color:var(--text);width:100%}

.modalOverlay{
position:fixed;inset:0;
background:rgba(0,0,0,.6);
display:none;align-items:center;justify-content:center;
}
.modal{
background:var(--panel);
padding:16px;border-radius:14px;
width:100%;max-width:420px;
}
</style>
</head>

<body>
<div class="app">

  <div class="row" style="margin-bottom:14px">
    <button class="btn btnGhost" onclick="setView('dashboard')">Dashboard</button>
    <button class="btn btnGhost" onclick="setView('cartoes')">Cartões</button>
    <button class="btn btnGhost" onclick="setView('fixas')">Fixas</button>
    <button class="btn btnGhost" onclick="setView('gastos')">Gastos</button>
    <button class="btn btnGhost" onclick="setView('receitas')">Receitas</button>
    <button class="btn btnGhost" onclick="fileInput.click()">Importar</button>
  </div>

  <input type="file" id="fileInput" accept=".json,.csv" hidden>

  <div id="view"></div>
</div>

<!-- MODAL CSV -->
<div class="modalOverlay" id="csvModal">
  <div class="modal">
    <h3>Selecionar cartão da fatura</h3>
    <select id="csvCard"></select>
    <div class="row" style="margin-top:12px">
      <button class="btn btnGhost" onclick="closeCSV()">Cancelar</button>
      <button class="btn btnGreen" onclick="confirmCSV()">Importar</button>
    </div>
  </div>
</div>

<script>
const STORAGE="metacartao_final_v1";
let data=JSON.parse(localStorage.getItem(STORAGE)||"{}");
if(!data.cards)data.cards={"Nubank":400,"Inter":400};
if(!data.transactions)data.transactions=[];
if(!data.incomes)data.incomes=[];

function save(){localStorage.setItem(STORAGE,JSON.stringify(data));}

function parseBR(v){return Number(String(v).replace(/\./g,"").replace(",","."));}
function fmt(d){return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`}
function parseDate(s){const[d,m,y]=s.split("/").map(Number);return new Date(y,m-1,d)}

function detectParcel(t){
if(!t)return null;
const m=t.match(/(\d+)\s*(?:\/|de)\s*(\d+)/i);
return m?{cur:+m[1],tot:+m[2]}:null;
}

/* ===== IMPORT ===== */
let csvText=null;

fileInput.onchange=e=>{
const f=e.target.files[0];if(!f)return;
const r=new FileReader();
r.onload=()=>{
if(f.name.endsWith(".json")){
data=JSON.parse(r.result);save();render();
}else{
csvText=r.result;openCSV();
}};
r.readAsText(f);
};

function openCSV(){
const s=document.getElementById("csvCard");
s.innerHTML="";
Object.keys(data.cards).forEach(c=>{
const o=document.createElement("option");
o.value=c;o.textContent=c;s.appendChild(o);
});
csvModal.style.display="flex";
}
function closeCSV(){csvModal.style.display="none"}

function confirmCSV(){
const card=csvCard.value;
importCSV(csvText,card);
closeCSV();
}

function importCSV(text,card){
const lines=text.split(/\r?\n/).filter(l=>l.trim());
const header=lines.shift().toLowerCase().split(",");
for(const ln of lines){
const cols=ln.split(",");
const row={};
header.forEach((h,i)=>row[h.trim()]=cols[i]?.trim());
const d=parseDate(row.data);
const val=parseBR(row.valor);
const desc=row.descricao||"Compra";
const parc=detectParcel(row.parcelas||desc);

if(!parc){
data.transactions.push({date:fmt(d),valor:val,cat:"Outros",card,desc});
}else{
const pval=+(val/parc.tot).toFixed(2);
for(let i=parc.cur;i<=parc.tot;i++){
const nd=new Date(d);nd.setMonth(nd.getMonth()+i-parc.cur);
data.transactions.push({
date:fmt(nd),valor:pval,cat:"Outros",card,
desc:`${desc} (${i}/${parc.tot})`
});
}
}
}
save();render();
}

/* ===== VIEWS ===== */
let view="dashboard";
function setView(v){view=v;render()}

function render(){
const v=document.getElementById("view");
v.innerHTML="";
if(view==="dashboard")renderDashboard(v);
if(view==="cartoes")renderCartoes(v);
if(view==="fixas")renderFixas(v);
if(view==="gastos")renderGastos(v);
if(view==="receitas")renderReceitas(v);
}

function renderDashboard(v){
const inc=data.incomes.reduce((a,b)=>a+b.valor,0);
const exp=data.transactions.reduce((a,b)=>a+b.valor,0);
v.innerHTML=`
<div class="panel">
<h3>Dashboard</h3>
<div class="item">Receitas: R$ ${inc.toFixed(2)}</div>
<div class="item">Despesas: R$ ${exp.toFixed(2)}</div>
<div class="item">Saldo: R$ ${(inc-exp).toFixed(2)}</div>
</div>`;
}

function renderCartoes(v){
const p=document.createElement("div");p.className="panel";
p.innerHTML="<h3>Cartões</h3>";
const l=document.createElement("div");l.className="list";
Object.entries(data.cards).forEach(([c,lim])=>{
const spent=data.transactions.filter(t=>t.card===c).reduce((a,b)=>a+b.valor,0);
l.innerHTML+=`<div class="item"><b>${c}</b><br>Limite: ${lim} | Gasto: ${spent}</div>`;
});
p.appendChild(l);v.appendChild(p);
}

function renderFixas(v){
const p=document.createElement("div");p.className="panel";
p.innerHTML="<h3>Fixas (adicionar manualmente como gasto)</h3>";
v.appendChild(p);
}

function renderGastos(v){
const p=document.createElement("div");p.className="panel";
p.innerHTML="<h3>Gastos</h3>";
const l=document.createElement("div");l.className="list";
data.transactions.slice().reverse().forEach(t=>{
l.innerHTML+=`<div class="item">${t.date} • ${t.card} • ${t.valor}<div class="muted">${t.desc}</div></div>`;
});
p.appendChild(l);v.appendChild(p);
}

function renderReceitas(v){
const p=document.createElement("div");p.className="panel";
p.innerHTML="<h3>Receitas</h3>";
v.appendChild(p);
}

render();
</script>
</body>
</html>
